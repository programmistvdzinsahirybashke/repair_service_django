{% extends "base.html" %}
{% load static %}
{% load carts_tags %}
{% load multiply %}

{% block title %}
Заказы пользователей
{% endblock %}

{% block content %}
<div class="container mt-5">
    <form method="get" class="mb-4 d-flex justify-content-between">
    <input type="text" name="search" class="form-control me-2" placeholder="Поиск по номеру или пользователю" value="{{ filters.search_query }}">

    <select name="status" class="form-select me-2">
        <option value="">Все статусы</option>
        {% for status, label in statuses %}
            <option value="{{ status }}" {% if filters.status_filter == status %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <select name="sort" class="form-select me-2">
        <option value="desc" {% if filters.sort_order == 'desc' %}selected{% endif %}>По убыванию ID</option>
        <option value="asc" {% if filters.sort_order == 'asc' %}selected{% endif %}>По возрастанию ID</option>
    </select>

    <button type="submit" class="btn btn-primary">Применить</button>
</form>
    </div>

    <!-- Оформленные заказы -->
    <div class="accordion" id="accordionExample">
        {% for order in orders %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ order.id }}">
                <button class="accordion-button {% if order != orders.0 %}collapsed{% endif %}"
                        type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ order.id }}"
                        aria-expanded="false" aria-controls="collapse{{ order.id }}">
                    Заказ № {{ order.id }} - {{ order.created_timestamp }} | Статус: <strong class="mx-2">{{ order.status.status_name }}</strong>
                </button>
            </h2>
            <div id="collapse{{ order.id }}"
                 class="accordion-collapse collapse {% if order == orders.0 %}show{% endif %}"
                 aria-labelledby="heading{{ order.id }}" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <p><strong>Информация о заказе №{{ order.id }}</strong></p>
                    <p><strong>Общая сумма:</strong> {{ order.total }} руб.</p>
                    {% if order.requires_delivery %}
                        <p><strong>Требуется выезд:</strong> Да</p>
                    {% else %}
                        <p><strong>Требуется выезд:</strong> Нет</p>
                    {% endif %}
                    {% if order.delivery_address %}
                        <p><strong>Адрес доставки:</strong> {{ order.delivery_address }}</p>
                    {% else %}
                        <p><strong>Адрес сдачи:</strong> г. Альметьевск, ул. Примерная 116</p>
                    {% endif %}
                    <p><strong>Комментарий:</strong> "{{ order.comment }}"</p>
                    <p><strong>Состав заказа:</strong></p>
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Товар</th>
                                <th>Количество</th>
                                <th>Цена</th>
                                <th>Общая стоимость</th>
                                <th>Статус</th>
                                <th>Дата выполнения</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.orderitem_set.all %}
                            <tr>
                                <td>{{ item.product.service_name }} | {{ item.product.category }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.price }}</td>
                                <td>{{ item.quantity|multiply:item.price|floatformat:2 }} руб.</td>
                                <td>{{ item.status.status_name }}</td>
                                <td>{{ item.work_ended_datetime|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
